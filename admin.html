<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>John Power Memorial Darts Tournament - Admin</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: #333;
      margin: 20px;
    }
    h2 {
      color: #3aafa9;
      text-align: center;
      margin-bottom: 20px;
    }
    textarea {
      width: 100%;
      height: 100px;
      padding: 10px;
      border: 2px solid #3aafa9;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 1rem;
      margin-bottom: 12px;
    }
    button {
      background-color: #3aafa9;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 1rem;
      border-radius: 6px;
      margin-right: 8px;
      margin-bottom: 12px;
      cursor: pointer;
    }
    button:hover {
      background-color: #2c8f8a;
    }
    .round {
      display: inline-block;
      vertical-align: top;
      margin-right: 16px;
      min-width: 220px;
    }
    .match {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .player {
      padding: 6px;
      cursor: pointer;
      border-radius: 4px;
      margin-bottom: 6px;
      user-select: none;
    }
    .player:hover {
      background-color: #d0f0ef;
    }
    .winner {
      background-color: #3aafa9;
      color: white;
      font-weight: bold;
    }
    input[type="text"] {
      margin-top: 6px;
      padding: 6px;
      border: 1px solid #3aafa9;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }
    @media (max-width: 768px) {
      .round {
        display: block;
        margin-right: 0;
        margin-bottom: 20px;
      }
    }
  </style>
</head>
<body>

  <h2>John Power Memorial Darts Tournament - Admin</h2>
  <a href="view.html" target="_blank" style="display:block; text-align:center; color:#3aafa9; margin-bottom:15px;">ðŸ”— View Public Bracket</a>

  <textarea id="players" placeholder="Enter one player per line..."></textarea><br />
  <button id="generate">Generate Bracket</button>
  <button id="reset">Clear</button>
  <button id="export">Export PDF</button>
  <button id="export-json">Export JSON</button>

  <div id="bracket"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let rounds = [];

    function saveBracket(data) {
      localStorage.setItem("bracket", JSON.stringify(data));
    }

    function loadBracket() {
      const data = localStorage.getItem("bracket");
      return data ? JSON.parse(data) : null;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function createBracket(players) {
      const matches = [];
      const totalPlayers = players.length;
      const roundsNeeded = Math.ceil(Math.log2(totalPlayers));
      const bracketSize = Math.pow(2, roundsNeeded);
      const byes = bracketSize - totalPlayers;

      shuffle(players);

      for (let i = 0; i < bracketSize; i += 2) {
        const p1 = players[i] || null;
        const p2 = players[i + 1] || null;
        matches.push({ player1: p1, player2: p2, winner: null });
      }

      const r = [matches];
      for (let i = 1; i < roundsNeeded; i++) {
        const empty = Array(Math.pow(2, roundsNeeded - i - 1)).fill().map(() => ({
          player1: null, player2: null, winner: null
        }));
        r.push(empty);
      }

      return r;
    }

    function render(rounds) {
      const bracketDiv = document.getElementById("bracket");
      bracketDiv.innerHTML = "";

      rounds.forEach((round, rIndex) => {
        const roundDiv = document.createElement("div");
        roundDiv.className = "round";

        const title = document.createElement("h4");
        title.textContent = getRoundName(rIndex, rounds.length);
        roundDiv.appendChild(title);

        round.forEach((match, mIndex) => {
          const matchDiv = document.createElement("div");
          matchDiv.className = "match";

          [1, 2].forEach(num => {
            const key = `player${num}`;
            const p = match[key];
            const div = document.createElement("div");
            div.className = "player";
            if (p === match.winner) div.classList.add("winner");

            div.textContent = p || `Winner of Match ${getPreviousMatchNumber(rounds, rIndex, mIndex, num)}`;
            div.onclick = () => {
              match.winner = p;
              render(rounds);
              saveBracket(rounds);
            };
            matchDiv.appendChild(div);
          });

          const boardInput = document.createElement("input");
          boardInput.type = "text";
          boardInput.placeholder = "Board #";
          boardInput.value = match.board || "";
          boardInput.onchange = () => {
            match.board = boardInput.value;
            saveBracket(rounds);
          };
          matchDiv.appendChild(boardInput);

          const markerInput = document.createElement("input");
          markerInput.type = "text";
          markerInput.placeholder = "Marker";
          markerInput.value = match.marker || "";
          markerInput.onchange = () => {
            match.marker = markerInput.value;
            saveBracket(rounds);
          };
          matchDiv.appendChild(markerInput);

          roundDiv.appendChild(matchDiv);
        });

        bracketDiv.appendChild(roundDiv);
      });
    }

    function getPreviousMatchNumber(rounds, rIndex, mIndex, playerNumber) {
      if (rIndex === 0) return "";
      const prevRound = rounds[rIndex - 1];
      const matchIndex = playerNumber === 1 ? mIndex * 2 : mIndex * 2 + 1;
      return matchIndex + 1;
    }

    function getRoundName(index, total) {
      const last = total - 1;
      if (index === last) return "Final";
      if (index === last - 1) return "Semi Final";
      if (index === last - 2) return "Quarter Final";
      if (index === last - 3) return "Last 16";
      return `Round ${index + 1}`;
    }

    function generateBracket() {
      const input = document.getElementById("players").value.trim();
      if (!input) return alert("Please enter players.");
      const players = input.split("\n").map(p => p.trim()).filter(p => p);
      rounds = createBracket(players);
      render(rounds);
      saveBracket(rounds);
    }

    document.getElementById("generate").onclick = generateBracket;

    document.getElementById("reset").onclick = () => {
      if (confirm("Clear all data?")) {
        localStorage.removeItem("bracket");
        rounds = [];
        document.getElementById("players").value = "";
        document.getElementById("bracket").innerHTML = "";
      }
    };

    document.getElementById("export").onclick = () => {
      html2canvas(document.getElementById("bracket")).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF();
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
        pdf.save("bracket.pdf");
      });
    };

    document.getElementById("export-json").onclick = () => {
      const blob = new Blob([JSON.stringify(rounds, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "bracket.json";
      link.click();
    };

    window.onload = () => {
      const saved = loadBracket();
      if (saved) {
        rounds = saved;
        render(saved);
      }
    };
  </script>

</body>
</html>
