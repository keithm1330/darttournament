<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Darts Tournament Admin</title>
<style>
  body { font-family: sans-serif; margin: 20px; background: #111; color: #eee; }
  textarea { width: 100%; height: 100px; font-size: 14px; margin-bottom: 10px; background: #222; color: #eee; border: 1px solid #444; }
  button { padding: 10px 20px; margin: 10px 5px; background: #d32f2f; color: white; border: none; border-radius: 6px; cursor: pointer; }
  button:hover { background: #b71c1c; }
  .round { display: inline-block; vertical-align: top; margin-right: 20px; min-width: 220px; background: #222; padding: 10px; border-radius: 6px; }
  .match { border: 1px solid #444; border-radius: 6px; padding: 8px; margin-bottom: 12px; background: #333; }
  .player { padding: 4px; cursor: pointer; border-radius: 4px; margin-bottom: 4px; user-select: none; }
  .player:hover { background: #444; }
  .winner { background: #4CAF50; color: white; font-weight: bold; }
  .board-input, .marker-input { width: 100%; box-sizing: border-box; padding: 4px; margin-top: 6px; background: #222; color: #eee; border: 1px solid #444; border-radius: 4px; }
</style>
</head>
<body>

<h2>Admin: John Power Memorial Darts Tournament</h2>
<textarea id="players" placeholder="Enter one player per line..."></textarea><br />
<button id="generate">Generate Bracket</button>
<button id="reset">Clear All</button>
<button id="export">Export Bracket JSON</button>

<div id="bracket"></div>

<script>
// Utility functions
function getPlayerName(player) {
  if (!player) return "";
  return typeof player === "object" ? player.name : player;
}

// Save/load bracket in localStorage for admin convenience
function saveBracket(data) {
  localStorage.setItem("bracket", JSON.stringify(data));
}

function loadBracket() {
  const data = localStorage.getItem("bracket");
  return data ? JSON.parse(data) : null;
}

// Bracket creation with byes only in round 1
function createBracket(players) {
  let totalPlayers = players.length;
  let nextPowerOf2 = 1;
  while (nextPowerOf2 < totalPlayers) nextPowerOf2 *= 2;
  let numByes = nextPowerOf2 - totalPlayers;

  players = players.sort(() => Math.random() - 0.5);

  const rounds = [];
  let matchId = 1;

  // Round 1
  const round1 = [];
  let idx = 0;
  while (idx < totalPlayers) {
    const p1 = players[idx++];
    let p2 = null;

    if (numByes > 0) {
      p2 = null;
      numByes--;
    } else if (idx < totalPlayers) {
      p2 = players[idx++];
    }

    round1.push({id: matchId++, player1: p1, player2: p2, winner: null, board: null, marker: null});
  }
  rounds.push(round1);

  // Subsequent rounds
  let currentRound = round1;
  while (currentRound.length > 1) {
    const nextRound = [];
    for (let i = 0; i < currentRound.length; i += 2) {
      const m1 = currentRound[i];
      const m2 = currentRound[i + 1];
      nextRound.push({
        id: matchId++,
        player1: {name: "", sourceMatchId: m1.id},
        player2: m2 ? {name: "", sourceMatchId: m2.id} : null,
        winner: null,
        board: null,
        marker: null
      });
    }
    rounds.push(nextRound);
    currentRound = nextRound;
  }
  return rounds;
}

function autoAdvanceByes(rounds) {
  const firstRound = rounds[0];
  for (const match of firstRound) {
    const p1 = getPlayerName(match.player1);
    const p2 = getPlayerName(match.player2);

    if (p1 && !p2 && !match.winner) {
      match.winner = p1;
      propagateWinner(rounds, match, p1);
    }
  }
}

function propagateWinner(rounds, match, winnerName) {
  for (let r = 1; r < rounds.length; r++) {
    for (const m of rounds[r]) {
      ["player1", "player2"].forEach(key => {
        const player = m[key];
        if (player && typeof player === "object" && player.sourceMatchId === match.id) {
          player.name = winnerName || "";
          if (m.winner !== getPlayerName(m.player1) && m.winner !== getPlayerName(m.player2)) {
            m.winner = null;
          }
        }
      });
    }
  }
  saveBracket(rounds);
}

function setWinner(rounds, match, name) {
  if (match.winner === name) {
    match.winner = null;
    propagateWinner(rounds, match, null);
  } else {
    match.winner = name;
    propagateWinner(rounds, match, name);
  }
  saveBracket(rounds);
  render(rounds);
}

function updateName(rounds, oldName, newName) {
  for (const round of rounds) {
    for (const match of round) {
      ["player1", "player2"].forEach(p => {
        if (getPlayerName(match[p]) === oldName) {
          if (typeof match[p] === "object") match[p].name = newName;
          else match[p] = newName;
        }
      });
      if (match.winner === oldName) match.winner = newName;
    }
  }
  saveBracket(rounds);
  render(rounds);
}

function render(rounds) {
  autoAdvanceByes(rounds);

  const bracket = document.getElementById("bracket");
  bracket.innerHTML = "";

  rounds.forEach((round, r) => {
    const div = document.createElement("div");
    div.className = "round";

    const roundNames = ["Final", "Semi Final", "Quarter Final"];
    const fromEnd = rounds.length - r - 1;
    if (fromEnd < 3) {
      div.appendChild(Object.assign(document.createElement("h4"), { textContent: roundNames[fromEnd] }));
    } else {
      div.appendChild(Object.assign(document.createElement("h4"), { textContent: `Round ${r + 1}` }));
    }

    round.forEach(match => {
      const p1 = getPlayerName(match.player1);
      const p2 = getPlayerName(match.player2);

      if (!p1 && !p2) return;

      const m = document.createElement("div");
      m.className = "match";

      const g = document.createElement("div");
      g.textContent = `Game ${match.id}`;
      g.style.fontWeight = "bold";
      m.appendChild(g);

      ["player1", "player2"].forEach(p => {
        const player = match[p];
        const name = getPlayerName(player);
        if (!name) return;

        const wrapper = document.createElement("div");
        wrapper.className = "player";
        wrapper.textContent = name;
        if (match.winner === name) wrapper.classList.add("winner");

        wrapper.onclick = () => setWinner(rounds, match, name);

        wrapper.ondblclick = () => {
          const input = document.createElement("input");
          input.type = "text";
          input.value = name;
          input.onblur = () => {
            const newVal = input.value.trim() || name;
            updateName(rounds, name, newVal);
          };
          input.onkeydown = (e) => {
            if (e.key === "Enter") input.blur();
          };
          m.replaceChild(input, wrapper);
          input.focus();
        };

        m.appendChild(wrapper);
      });

      // Board input
      const b = document.createElement("input");
      b.type = "number";
      b.min = 1;
      b.max = 12;
      b.placeholder = "Board #";
      b.className = "board-input";
      b.value = match.board || "";
      b.onchange = () => {
        match.board = b.value ? parseInt(b.value) : null;
        saveBracket(rounds);
      };
      m.appendChild(b);

      // Marker input
      const markerInput = document.createElement("input");
      markerInput.type = "text";
      markerInput.placeholder = "Marker (optional)";
      markerInput.className = "marker-input";
      markerInput.value = match.marker || "";
      markerInput.onchange = () => {
        match.marker = markerInput.value.trim() || null;
        saveBracket(rounds);
      };
      m.appendChild(markerInput);

      div.appendChild(m);
    });

    bracket.appendChild(div);
  });
}

function generate() {
  const players = document.getElementById("players").value.trim().split("\n").filter(Boolean);
  if (players.length < 2) {
    alert("Please enter at least 2 players.");
    return;
  }
  const rounds = createBracket(players);
  saveBracket(rounds);
  render(rounds);
}

document.getElementById("generate").onclick = generate;

document.getElementById("reset").onclick = () => {
  if (confirm("Clear all data?")) {
    localStorage.removeItem("bracket");
    document.getElementById("players").value = "";
    document.getElementById("bracket").innerHTML = "";
  }
};

document.getElementById("export").onclick = () => {
  const rounds = loadBracket();
  if (!rounds) {
    alert("No bracket data to export. Generate bracket first.");
    return;
  }
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(rounds, null, 2));
  const dlAnchor = document.createElement('a');
  dlAnchor.setAttribute("href", dataStr);
  dlAnchor.setAttribute("download", "bracket.json");
  document.body.appendChild(dlAnchor);
  dlAnchor.click();
  dlAnchor.remove();
};

window.onload = () => {
  const saved = loadBracket();
  if (saved) render(saved);
};
</script>

</body>
</html>
